---
title: main
description: /root/percona-xtrabackup-release-8.0.32-26/storage/innobase/xtrabackup/src/xtrabackup.cc
date: 2023-10-30
weight: 10000


---
<style>
th, td {
  border: 1px solid rgb(190, 190, 190);
}
</style>
{{< alert >}}

```sql
xtrabackup \
    --password=123456 \
    --user="root" \
    --backup \
    --datadir=/var/lib/mysql/ \
    --socket=/var/run/mysqld/mysqld.sock \
    --target-dir=/data/mysqlbackup/base

--- xtrabackup_checkpoints >> to_lsn


 xtrabackup \
    --password=123456 \
    --user="root" \
    --backup \
    --datadir=/var/lib/mysql/ \
    --socket=/var/run/mysqld/mysqld.sock \
    --target-dir=/data/mysqlbackup/inc1 \
    --incremental-basedir=/data/mysqlbackup/base


xtrabackup \
    --password=123456 \
    --user="root" \
    --backup \
    --datadir=/var/lib/mysql/ \
    --socket=/var/run/mysqld/mysqld.sock \
    --target-dir=/data/mysqlbackup/inc1 \
    --incremental-lsn=1308181910

```


假设你有如下备份集,一个全备，两个增备，需要进行如下操作，使得备份集达到一致：
- /data/mysqlbackup/base
- /data/mysqlbackup/inc1
- /data/mysqlbackup/inc2

### 恢复
```sql
xtrabackup --prepare --apply-log-only --target-dir=/data/mysqlbackup/base
xtrabackup --prepare --apply-log-only --target-dir=/data/mysqlbackup/base --incremental-dir=/data/mysqlbackup/inc1
xtrabackup --prepare --target-dir=/data/mysqlbackup/base --incremental-dir=/data/mysqlbackup/inc2
```





{{< /alert >}}


```c++
int main(int argc, char **argv) {
  char **client_defaults, **server_defaults;
  int client_argc, server_argc;
  char cwd[FN_REFLEN];

  orig_argc = argc;
  orig_argv = argv;

  /* Logs xtrabackup generated timestamps in local timezone instead of UTC */
  opt_log_timestamps = 1;

  setup_signals();

  MY_INIT(argv[0]);

  current_thd = NULL;

  xb_regex_init();

  capture_tool_command(argc, argv);

  if (mysql_server_init(-1, NULL, NULL)) {
    exit(EXIT_FAILURE);
  }

  /* Setup logging before handle_options(), so that error
  generated by handle_options() are displayed to user */
  system_charset_info = &my_charset_utf8mb3_general_ci;
  files_charset_info = &my_charset_utf8mb3_general_ci;
  national_charset_info = &my_charset_utf8mb3_general_ci;
  table_alias_charset = &my_charset_bin;
  character_set_filesystem = &my_charset_bin;

  sys_var_init();
  setup_error_messages();

  init_error_log();
  setup_error_log_components();

  handle_options(argc, argv, &client_argc, &client_defaults, &server_argc,
                 &server_defaults);

  print_version();

  atexit(destroy_error_log);

  if (xtrabackup_encrypt) {
    xb_libgcrypt_init();
  }

  if ((!xtrabackup_print_param) && (!xtrabackup_prepare) &&
      (strcmp(mysql_data_home, "./") == 0)) {
    if (!xtrabackup_print_param) usage();
    xb::error() << "Please set parameter 'datadir'";
    exit(EXIT_FAILURE);
  }

  /* Expand target-dir, incremental-basedir, etc. */

  my_getwd(cwd, sizeof(cwd), MYF(0));

  my_load_path(xtrabackup_real_target_dir, xtrabackup_target_dir, cwd);
  unpack_dirname(xtrabackup_real_target_dir, xtrabackup_real_target_dir);
  xtrabackup_target_dir = xtrabackup_real_target_dir;
  xb_set_plugin_dir();
  if (xtrabackup_incremental_basedir) {
    my_load_path(xtrabackup_real_incremental_basedir,
                 xtrabackup_incremental_basedir, cwd);
    unpack_dirname(xtrabackup_real_incremental_basedir,
                   xtrabackup_real_incremental_basedir);
    xtrabackup_incremental_basedir = xtrabackup_real_incremental_basedir;
  }

  if (xtrabackup_incremental_dir) {
    my_load_path(xtrabackup_real_incremental_dir, xtrabackup_incremental_dir,
                 cwd);
    unpack_dirname(xtrabackup_real_incremental_dir,
                   xtrabackup_real_incremental_dir);
    xtrabackup_incremental_dir = xtrabackup_real_incremental_dir;
  }

  if (xtrabackup_extra_lsndir) {
    my_load_path(xtrabackup_real_extra_lsndir, xtrabackup_extra_lsndir, cwd);
    unpack_dirname(xtrabackup_real_extra_lsndir, xtrabackup_real_extra_lsndir);
    xtrabackup_extra_lsndir = xtrabackup_real_extra_lsndir;
  }

  /* get default temporary directory */
  if (!opt_mysql_tmpdir || !opt_mysql_tmpdir[0]) {
    opt_mysql_tmpdir = getenv("TMPDIR");
#if defined(__WIN__)
    if (!opt_mysql_tmpdir) {
      opt_mysql_tmpdir = getenv("TEMP");
    }
    if (!opt_mysql_tmpdir) {
      opt_mysql_tmpdir = getenv("TMP");
    }
#endif
    if (!opt_mysql_tmpdir || !opt_mysql_tmpdir[0]) {
      opt_mysql_tmpdir = const_cast<char *>(DEFAULT_TMPDIR);
    }
  }

  /* temporary setting of enough size */
  srv_page_size_shift = UNIV_PAGE_SIZE_SHIFT_MAX;
  srv_page_size = UNIV_PAGE_SIZE_MAX;
  if (xtrabackup_backup && xtrabackup_incremental) {
    /* direct specification is only for --backup */
    /* and the lsn is prior to the other option */

    char *endchar;
    int error = 0;
    incremental_lsn = strtoll(xtrabackup_incremental, &endchar, 10);
    if (*endchar != '\0') error = 1;

    if (error) {
      xb::error() << "value " << SQUOTE(xtrabackup_incremental)
                  << " may be wrong format for incremental option.";
      exit(EXIT_FAILURE);
    }
  } else if (xtrabackup_backup && xtrabackup_incremental_basedir) {
    char filename[FN_REFLEN];

    sprintf(filename, "%s/%s", xtrabackup_incremental_basedir,
            XTRABACKUP_METADATA_FILENAME);

    if (!xtrabackup_read_metadata(filename)) {
      xb::error() << "failed to read metadata from " << filename;
      exit(EXIT_FAILURE);
    }

    incremental_lsn = metadata_to_lsn;
    xtrabackup_incremental = xtrabackup_incremental_basedir;  // dummy
  } else if (xtrabackup_prepare && xtrabackup_incremental_dir) {
    char filename[FN_REFLEN];

    sprintf(filename, "%s/%s", xtrabackup_incremental_dir,
            XTRABACKUP_METADATA_FILENAME);

    if (!xtrabackup_read_metadata(filename)) {
      xb::error() << "failed to read metadata from " << filename;
      exit(EXIT_FAILURE);
    }

    incremental_lsn = metadata_from_lsn;
    incremental_to_lsn = metadata_to_lsn;
    incremental_last_lsn = metadata_last_lsn;
    incremental_flushed_lsn = backup_redo_log_flushed_lsn;
    xtrabackup_incremental = xtrabackup_incremental_dir;  // dummy
    incremental_redo_memory = redo_memory;
    incremental_redo_frames = redo_frames;

  } else if (opt_incremental_history_name) {
    xtrabackup_incremental = opt_incremental_history_name;
  } else if (opt_incremental_history_uuid) {
    xtrabackup_incremental = opt_incremental_history_uuid;
  } else {
    xtrabackup_incremental = NULL;
  }

  if (!xb_init()) {
    exit(EXIT_FAILURE);
  }

  /* --print-param */
  if (xtrabackup_print_param) {
    printf("%s", print_param_str.str().c_str());

    exit(EXIT_SUCCESS);
  }

  if (xtrabackup_incremental) {
    xb::info() << "incremental backup from " << incremental_lsn
               << " is enabled.";
  }

  if (xtrabackup_export && innobase_file_per_table == false) {
    xb::info() << "auto-enabling --innodb-file-per-table due to "
                  "the --export option";
    innobase_file_per_table = true;
  }

  if (xtrabackup_throttle && !xtrabackup_backup) {
    xtrabackup_throttle = 0;
    xb::warn() << "--throttle has effect only with --backup";
  }

  /* cannot execute both for now */
  {
    int num = 0;

    if (xtrabackup_backup) num++;
    if (xtrabackup_stats) num++;
    if (xtrabackup_prepare) num++;
    if (xtrabackup_copy_back) num++;
    if (xtrabackup_move_back) num++;
    if (xtrabackup_decrypt_decompress) num++;
    if (num != 1) { /* !XOR (for now) */
      usage();
      exit(EXIT_FAILURE);
    }
  }
  if (opt_component_keyring_file_config != nullptr) {
    xb::warn() << "--component-keyring-file-config is deprecated, please use "
               << " --component-keyring-config instead.";
    if (opt_component_keyring_config != nullptr) {
      xb::error() << "--component-keyring-file-config and "
                  << "--component-keyring-config are mutually exclusive."
                  << "Please use --component-keyring-config.";
      exit(EXIT_FAILURE);
    }
    opt_component_keyring_config =
        static_cast<char *>(opt_component_keyring_file_config);
  }

#ifndef __WIN__
  if (xtrabackup_debug_sync) {
    signal(SIGCONT, sigcont_handler);
  }
#endif

  /* --backup */
  if (xtrabackup_backup) {
    xtrabackup_backup_func();
  }

  /* --stats */
  if (xtrabackup_stats) {
    xtrabackup_stats_func(server_argc, server_defaults);
  }

  /* --prepare */
  if (xtrabackup_prepare) {
    xtrabackup_prepare_func(server_argc, server_defaults);
  }

  if (xtrabackup_copy_back || xtrabackup_move_back) {
    if (!check_if_param_set("datadir")) {
      xb::error() << "datadir must be specified.";
      exit(EXIT_FAILURE);
    }

    /* abort backup  if target is not prepared */
    read_metadata();
    if (strcmp(metadata_type_str, "full-prepared") != 0) {
      xb::error() << "The target is not fully prepared. Please prepare it "
                     "without option --apply-log-only";
      exit(EXIT_FAILURE);
    }

    init_mysql_environment();
    if (!copy_back(server_argc, server_defaults)) {
      exit(EXIT_FAILURE);
    }
    cleanup_mysql_environment();
  }

  if (xtrabackup_decrypt_decompress && !decrypt_decompress()) {
    exit(EXIT_FAILURE);
  }

  backup_cleanup();

  xb_regex_end();

  xb::info() << "completed OK!";

  exit(EXIT_SUCCESS);
}

```


###

`xb::info() << "completed OK!";` 备份成功标志：`completed OK!`
