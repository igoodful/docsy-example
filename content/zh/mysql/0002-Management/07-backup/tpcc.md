---
title: tpcc
description: tpcc
date: 2023-10-13
weight: 20000


---

{{< alert >}}
This is a placeholder page. Replace it with your own content.
{{< /alert >}}


## 慢日志案例如下：




{{< alert color="secondary" >}}

1. 不仅记录了select语句，还记录了insert、delete、update语句超过long_query_time阈值的SQL




{{< /alert >}}


TPCC 工具安装和测试

## 一 部署TPCC

### 1. 下载软件包
- 下载链接地址：[https://github.com/Percona-Lab/tpcc-mysql/archive/refs/heads/master.zip](https://github.com/Percona-Lab/tpcc-mysql/archive/refs/heads/master.zip)
- 下载libmysqlclient: [https://repo.mysql.com//mysql80-community-release-el7-7.noarch.rpm](https://repo.mysql.com//mysql80-community-release-el7-7.noarch.rpm)

### 2. 安装
1. 上传软件包到系统，并解压。
```sql
cd /software/tool/

unzip tpcc-mysql-master.zip

cd tpcc-mysql-master/src

make all
```

2. 修改安装包内容
因集中式数据库（或者MGR）新建表需要主键，修改建表语句文件，为history表添加自增列。

`cat /software/tool/tpcc-mysql-master/create_table.sql`
```sql
drop table if exists history;

create table history (
id int auto_increment,
h_c_id int,
h_c_d_id tinyint,
h_c_w_id smallint,
h_d_id tinyint,
h_w_id smallint,
h_date datetime,
h_amount decimal(6,2),
h_data varchar(24) , primary key(id)) Engine=InnoDB;
```

修改源代码load模块中INSERT INTO history语句:
- 添加了null
- 修改为48

`cat  /software/tool/tpcc-mysql-master/src/load.c`
```c
if( mysql_stmt_prepare(stmt[4],
                               "INSERT INTO customer values(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?, 10.0, 1, 0,?)",
                               76) ) goto Error_SqlCall_close;
        if( mysql_stmt_prepare(stmt[5],
                               "INSERT INTO history values(null,?,?,?,?,?,?,?,?)",
                               48) ) goto Error_SqlCall_close;
        if( mysql_stmt_prepare(stmt[6],
                               "INSERT INTO orders values(?,?,?,?,?,NULL,?, 1)",
                               46) ) goto Error_SqlCall_close;

```

## 创建数据库
```sql
cd tpcc-mysql-master/src

mysql -uroot -p'123456' -h127.0.0.1 -P3306 -e "create database tpcc1000;"

mysql -uroot -p'123456' -h127.0.0.1 -P3306 tpcc1000 < create_table.sql

mysql  -uroot -p'123456' -h127.0.0.1 -P3306 tpcc1000 < add_fkey_idx.sql
```

## 加载数据
```sql
cd /software/tool/tpcc-mysql-master

./tpcc_load -h 192.168.1.114 -P 3306 -d tpcctest -u root -p root1234 -w 10

./tpcc_load -d tpcctest  -u admin -p '123456' -h 10.5.43.7 -P 16310 -w 100 > 2023-11-23.sql  &

```
{{<note>}}
<!---->
tpcc_load -h server_host -P port -d database_name -u mysql_user -p mysql_password -w warehouses -l part -m min_wh -n max_wh

- -h 指定主机名

- -P 指定mysql端口

- -d 指定库名

- -u 指定用户

- -p 指定密码

- -w 指定仓库数

- -l 指定* [part]: 1=ITEMS 2=WAREHOUSE 3=CUSTOMER 4=ORDERS

- -m 指定最小warehouse

- -n 指定最大warehouse


{{</note>}}

## 运行 tpcc-mysql 开始测试
```sql
cd /software/tool/tpcc-mysql-master

./tpcc_start -h 192.168.1.114 -P 3306 -d tpcctest -u root -p root1234 -w 5  -c 16 -r 10 -l 300 >tpcc_5.txt

./tpcc_start -h 192.168.1.114 -P 3306 -d tpcctest -u root -p root1234 -w 10 -c 16 -r 10 -l 300 >tpcc_10.txt

```


{{<note>}}
<!---->
真实测试场景中，建议预热时间不小于5分钟，持续压测时长不小于30分钟，否则测试数据可能不具参考意义。

tpcc_start  -h 192.168.1.114 -P 3306 -d tpcctest -u root -p root1234 -w 1000 -c 32 -r 120 -l 3600 -f tpcc.txt >> tpcc.log 2>&1

- -w 指定仓库数量

- -c 指定并发连接数，默认为1

- -r 指定开始测试前进行warmup的时间，单位s，进行预热后，测试效果更好

- -l 指定测试持续时间，单位s，至少1个小时，即3600

- -i  指定生成报告间隔时长，默认每隔10秒生成报告

- -f 指定生成的报告文件名


{{</note>}}

1.5生成数据分析图像

1.5.1安装gnuplot画图工具

yum install gnuplot

### 编写分析数据和生成图像的脚本
编写生成图片脚本
```sql
cat >tpcc_graph.sh<<eof
#!/bin/bash
rm -f '$2'
gnuplot << EOP
datafile = '$1'
set terminal jpeg size 640,480
set grid x y
set xlabel "Time (sec)"
set ylabel "Transactions"
set output '$2'
plot datafile using 1:2 title "23399, w=5 c=16" with lines,\
datafile using 3:4 title "23399, w=10 c=16" with lines axes x1y1
EOP
eof
```


### 开始生成数据分析图片
```sql
grep -i trx tpcc_5.txt | awk '{printf "%d %3d\n",$1,$3}' > tpcc_output_5w.txt
grep -i trx tpcc_10.txt | awk '{printf "%d %3d\n",$1,$3}' > tpcc_output_10w.txtbash
paste tpcc_output_5w.txt tpcc_output_10w.txt   > tpcc_graph_data.txt
bash tpcc_graph.sh tpcc_graph_data.txt tpcc_graph.jpg
```



```sql
./tpcc_start -h 10.5.43.7 -P 16310 -d tpcctest -u admin -p '123456' -w 5  -c 32 -r 10 -l 300 >tpcc_5.txt

./tpcc_start -h 10.5.43.7 -P 16310 -d tpcctest -u admin -p '123456' -w 10  -c 32 -r 10 -l 300 >tpcc_10.txt
```





[https://developer.aliyun.com/article/647741](https://developer.aliyun.com/article/647741)


## 案例

| 指标   | 值    | 备注 |
|:-------|:------|:-----|
| Memory | 64G   |      |
| CPU    | 16C   |      |
| OS     | ky10  |      |
| Arch   | arm64 |      |


```sql
./tpcc_start -h 127.0.0.1 -P 16310 -d tpcctest -u admin -p '123456' -w 100 -r 30 -c 16 -l 900 -f w100_r30_c16_l900.txt > w100_r30_c16_l900.log 2>&1 &
```

```sql
***************************************
*** ###easy### TPC-C Load Generator ***
***************************************
option h with value '127.0.0.1'
option P with value '16310'
option d with value 'tpcctest'
option u with value 'admin'
option p with value '123456'
option w with value '100'  -- 仓库数，必须和tpcc_load一致：100个
option r with value '30'  -- 预热时间：30秒
option c with value '16'  -- 连接数，可认为是线程数：16线程
option l with value '900'  -- 测试执行时间，没有-i参数，则默认产生报告的时间间隔为10秒，即每10秒输出一次测压数据
option f with value 'w100_r30_c16_l900.txt'
<Parameters>
     [server]: 127.0.0.1
     [port]: 16310
     [DBname]: tpcctest
       [user]: admin
       [pass]: 123456
  [warehouse]: 100
 [connection]: 16
     [rampup]: 30 (sec.)
    [measure]: 900 (sec.)

RAMP-UP TIME.(30 sec.)

MEASURING START.
--
  10, trx: 2425, 95%: 51.645, 99%: 60.452, max_rt: 115.004, 2416|65.653, 241|12.825, 243|146.846, 242|167.750
  20, trx: 2223, 95%: 55.591, 99%: 64.915, max_rt: 81.375, 2227|55.139, 223|9.173, 222|147.005, 223|168.001
  30, trx: 2249, 95%: 54.996, 99%: 70.464, max_rt: 96.555, 2242|56.489, 226|7.448, 224|170.557, 224|204.847
  40, trx: 2294, 95%: 53.294, 99%: 62.945, max_rt: 76.018, 2297|48.644, 228|10.569, 230|135.252, 230|150.831
  50, trx: 2316, 95%: 52.612, 99%: 62.028, max_rt: 86.239, 2308|56.071, 232|8.599, 232|143.175, 232|181.055
  60, trx: 2266, 95%: 54.913, 99%: 65.110, max_rt: 91.640, 2266|38.822, 227|12.442, 227|171.980, 227|184.652
  70, trx: 2331, 95%: 54.000, 99%: 61.806, max_rt: 83.638, 2327|57.342, 233|7.573, 232|144.537, 233|152.919
  80, trx: 2327, 95%: 52.976, 99%: 63.304, max_rt: 84.022, 2324|69.908, 232|7.975, 233|139.359, 230|165.208
  90, trx: 2290, 95%: 53.904, 99%: 67.149, max_rt: 111.749, 2290|63.722, 229|9.877, 229|163.189, 230|200.478
 100, trx: 2337, 95%: 52.581, 99%: 61.529, max_rt: 92.522, 2338|64.190, 234|10.382, 234|139.354, 235|169.466
 110, trx: 2275, 95%: 55.992, 99%: 66.469, max_rt: 77.414, 2273|55.112, 228|10.599, 228|135.775, 227|175.760
 120, trx: 2306, 95%: 53.920, 99%: 64.509, max_rt: 100.601, 2301|45.162, 230|16.674, 230|148.900, 230|178.170
 130, trx: 2354, 95%: 52.881, 99%: 61.326, max_rt: 82.318, 2348|61.682, 236|7.401, 236|137.738, 236|149.549
 140, trx: 2334, 95%: 52.486, 99%: 61.418, max_rt: 75.158, 2332|49.790, 233|10.471, 233|144.298, 233|182.138
 150, trx: 2392, 95%: 49.927, 99%: 60.001, max_rt: 99.560, 2389|47.891, 240|7.513, 239|180.395, 239|154.649
 160, trx: 2272, 95%: 55.045, 99%: 66.469, max_rt: 113.966, 2268|95.529, 227|8.038, 228|192.881, 227|194.647
 170, trx: 2403, 95%: 50.741, 99%: 59.234, max_rt: 76.752, 2400|46.134, 240|7.230, 240|147.059, 240|151.464
 180, trx: 2369, 95%: 52.111, 99%: 64.085, max_rt: 108.309, 2364|66.328, 236|14.175, 236|193.127, 238|221.247
 190, trx: 2309, 95%: 53.726, 99%: 63.932, max_rt: 94.868, 2307|75.958, 232|7.751, 231|151.039, 230|192.591
 200, trx: 2367, 95%: 51.877, 99%: 61.898, max_rt: 103.731, 2369|63.062, 237|8.622, 237|150.408, 237|153.228
 210, trx: 2313, 95%: 53.119, 99%: 62.869, max_rt: 82.753, 2310|55.044, 231|9.471, 232|151.048, 232|173.693
 220, trx: 2387, 95%: 50.347, 99%: 56.278, max_rt: 67.296, 2382|51.646, 238|13.008, 237|126.650, 237|144.593
 230, trx: 2341, 95%: 51.877, 99%: 61.033, max_rt: 116.670, 2338|100.408, 235|7.533, 235|241.798, 235|140.675
 240, trx: 2355, 95%: 54.325, 99%: 71.548, max_rt: 101.697, 2351|51.747, 235|10.568, 235|171.753, 235|228.549
 250, trx: 2312, 95%: 52.597, 99%: 60.001, max_rt: 84.804, 2306|55.670, 231|9.760, 232|137.380, 232|141.683
 260, trx: 2337, 95%: 54.308, 99%: 64.547, max_rt: 82.654, 2336|62.393, 235|9.003, 233|148.603, 234|182.797
 270, trx: 2334, 95%: 52.080, 99%: 64.162, max_rt: 93.775, 2334|62.077, 232|7.482, 234|162.096, 233|181.517
 280, trx: 2389, 95%: 53.438, 99%: 63.665, max_rt: 88.520, 2386|52.356, 239|9.377, 239|156.543, 239|167.570
 290, trx: 2375, 95%: 51.291, 99%: 59.643, max_rt: 87.492, 2374|51.957, 238|7.422, 237|143.756, 237|145.248
 300, trx: 2306, 95%: 53.791, 99%: 63.190, max_rt: 95.328, 2306|74.832, 231|9.912, 232|150.834, 231|173.246
 310, trx: 2320, 95%: 54.946, 99%: 66.231, max_rt: 80.198, 2317|50.403, 232|10.508, 231|149.048, 233|167.494
 320, trx: 2355, 95%: 51.260, 99%: 58.092, max_rt: 74.384, 2354|49.855, 235|12.257, 236|139.630, 234|145.777
 330, trx: 2378, 95%: 51.568, 99%: 62.289, max_rt: 102.033, 2379|48.824, 238|16.457, 238|173.453, 239|199.927
 340, trx: 2409, 95%: 51.275, 99%: 58.915, max_rt: 87.135, 2396|42.041, 241|8.380, 240|137.596, 241|147.100
 350, trx: 2352, 95%: 52.142, 99%: 60.397, max_rt: 73.256, 2348|39.682, 235|10.613, 235|131.198, 234|145.424
 360, trx: 2414, 95%: 51.398, 99%: 63.665, max_rt: 93.090, 2413|56.225, 241|6.659, 242|153.496, 241|186.341
 370, trx: 2419, 95%: 50.513, 99%: 61.658, max_rt: 87.849, 2417|52.429, 242|7.183, 242|144.113, 243|165.066
 380, trx: 2407, 95%: 50.604, 99%: 57.435, max_rt: 81.256, 2400|57.557, 241|11.721, 240|133.117, 241|147.860
 390, trx: 2314, 95%: 54.471, 99%: 69.397, max_rt: 120.546, 2316|46.537, 232|9.814, 232|178.789, 231|213.271
 400, trx: 2310, 95%: 53.023, 99%: 61.198, max_rt: 68.655, 2303|49.040, 230|11.496, 231|138.130, 231|151.891
 410, trx: 2298, 95%: 53.904, 99%: 64.625, max_rt: 84.920, 2293|49.231, 230|11.093, 229|148.776, 230|178.263
 420, trx: 2286, 95%: 53.726, 99%: 63.304, max_rt: 86.714, 2287|46.831, 228|10.628, 230|160.310, 228|176.268
 430, trx: 2372, 95%: 51.275, 99%: 58.284, max_rt: 92.307, 2369|45.751, 238|7.009, 236|129.634, 237|143.052
 440, trx: 2357, 95%: 50.726, 99%: 58.529, max_rt: 79.023, 2356|52.108, 235|8.962, 236|128.411, 236|149.256
 450, trx: 2338, 95%: 52.581, 99%: 60.415, max_rt: 105.878, 2332|47.174, 234|9.882, 234|138.920, 234|158.591
 460, trx: 2362, 95%: 51.784, 99%: 61.125, max_rt: 85.140, 2362|66.736, 236|6.931, 237|143.535, 236|165.976
 470, trx: 2361, 95%: 52.817, 99%: 61.107, max_rt: 87.451, 2357|57.989, 236|8.502, 235|140.391, 236|168.208
 480, trx: 2331, 95%: 52.754, 99%: 65.266, max_rt: 92.941, 2327|60.688, 234|16.354, 233|156.694, 233|174.991
 490, trx: 2433, 95%: 49.659, 99%: 58.266, max_rt: 75.975, 2439|45.280, 243|12.319, 244|132.964, 244|152.081
 500, trx: 2466, 95%: 49.763, 99%: 57.763, max_rt: 96.419, 2461|48.303, 246|8.516, 247|154.170, 246|176.736
 510, trx: 2207, 95%: 56.735, 99%: 70.718, max_rt: 93.677, 2204|56.640, 221|12.511, 221|157.099, 221|203.660
 520, trx: 2345, 95%: 52.565, 99%: 61.732, max_rt: 91.315, 2346|45.089, 235|18.523, 233|141.582, 234|174.428
 530, trx: 2314, 95%: 53.230, 99%: 62.084, max_rt: 85.282, 2311|65.260, 231|9.774, 231|139.537, 232|154.834
 540, trx: 2283, 95%: 54.146, 99%: 71.892, max_rt: 153.835, 2280|119.255, 229|10.717, 229|229.082, 228|189.440
 550, trx: 2314, 95%: 53.135, 99%: 62.363, max_rt: 76.790, 2315|49.699, 231|7.904, 231|142.270, 232|162.765
 560, trx: 2349, 95%: 51.924, 99%: 58.319, max_rt: 73.885, 2347|53.063, 235|10.306, 235|141.058, 235|142.637
 570, trx: 2343, 95%: 52.534, 99%: 64.915, max_rt: 93.123, 2333|49.439, 234|11.639, 235|148.184, 234|168.108
 580, trx: 2458, 95%: 49.422, 99%: 56.922, max_rt: 89.784, 2461|42.908, 246|13.869, 245|143.423, 245|142.433
 590, trx: 2345, 95%: 52.424, 99%: 60.597, max_rt: 104.349, 2342|53.322, 235|12.834, 235|142.032, 234|151.039
 600, trx: 2296, 95%: 53.775, 99%: 65.875, max_rt: 95.928, 2295|52.811, 229|7.920, 229|152.864, 230|158.759
 610, trx: 2264, 95%: 54.635, 99%: 67.755, max_rt: 90.128, 2261|63.353, 226|14.148, 227|162.854, 227|210.582
 620, trx: 2363, 95%: 51.769, 99%: 58.057, max_rt: 73.896, 2361|62.962, 236|12.875, 236|127.897, 236|151.951
 630, trx: 2254, 95%: 56.312, 99%: 69.231, max_rt: 99.058, 2253|76.235, 226|11.449, 226|161.426, 225|182.616
 640, trx: 2415, 95%: 51.260, 99%: 60.488, max_rt: 95.510, 2413|55.751, 241|7.312, 241|135.565, 243|143.842
 650, trx: 2314, 95%: 53.103, 99%: 61.455, max_rt: 73.195, 2310|67.890, 232|9.648, 232|132.968, 230|155.183
 660, trx: 2353, 95%: 53.007, 99%: 61.824, max_rt: 78.355, 2351|49.320, 236|8.770, 235|134.652, 235|157.226
 670, trx: 2333, 95%: 52.738, 99%: 61.326, max_rt: 82.078, 2332|55.271, 233|10.060, 233|135.477, 234|153.496
 680, trx: 2446, 95%: 48.717, 99%: 55.508, max_rt: 87.926, 2442|53.733, 244|6.353, 245|122.812, 245|141.597
 690, trx: 2402, 95%: 52.723, 99%: 67.028, max_rt: 95.791, 2401|60.047, 240|11.451, 241|188.796, 240|227.769
 700, trx: 2455, 95%: 50.107, 99%: 56.430, max_rt: 69.966, 2456|48.119, 245|10.201, 245|121.734, 245|153.396
 710, trx: 2266, 95%: 54.635, 99%: 64.316, max_rt: 93.003, 2263|40.809, 228|10.244, 227|154.665, 228|185.445
 720, trx: 2263, 95%: 55.492, 99%: 68.838, max_rt: 90.189, 2263|43.775, 226|10.654, 226|172.847, 226|187.942
 730, trx: 2382, 95%: 51.986, 99%: 60.145, max_rt: 76.058, 2379|53.567, 238|8.373, 238|134.682, 237|148.717
 740, trx: 2243, 95%: 53.678, 99%: 62.775, max_rt: 330.992, 2238|313.911, 224|9.200, 224|414.515, 225|160.151
 750, trx: 2337, 95%: 52.928, 99%: 60.851, max_rt: 80.627, 2334|67.834, 234|9.645, 233|129.957, 233|159.278
 760, trx: 2284, 95%: 53.342, 99%: 61.547, max_rt: 84.840, 2279|52.502, 229|8.893, 229|165.049, 229|177.511
 770, trx: 2389, 95%: 51.846, 99%: 60.019, max_rt: 79.843, 2388|58.645, 238|12.596, 239|145.031, 239|155.913
 780, trx: 2336, 95%: 52.597, 99%: 66.409, max_rt: 104.330, 2331|51.849, 234|11.310, 234|169.723, 233|181.391
 790, trx: 2371, 95%: 51.015, 99%: 60.778, max_rt: 70.996, 2369|68.401, 237|8.289, 237|152.508, 237|164.204
 800, trx: 2265, 95%: 55.094, 99%: 65.052, max_rt: 78.891, 2261|42.624, 227|11.037, 227|153.520, 227|177.842
 810, trx: 2324, 95%: 52.881, 99%: 62.289, max_rt: 95.973, 2324|41.132, 232|9.400, 232|149.461, 232|151.944
 820, trx: 2455, 95%: 49.083, 99%: 57.797, max_rt: 79.493, 2456|51.679, 245|12.537, 246|136.438, 246|155.840
 830, trx: 2305, 95%: 54.227, 99%: 64.799, max_rt: 81.036, 2301|67.965, 231|11.872, 230|139.438, 230|157.561
 840, trx: 2293, 95%: 54.406, 99%: 68.879, max_rt: 101.743, 2287|47.634, 229|8.615, 229|177.440, 229|204.478
 850, trx: 2248, 95%: 55.875, 99%: 66.988, max_rt: 112.568, 2237|50.400, 225|9.034, 224|144.471, 226|180.320
 860, trx: 2372, 95%: 50.559, 99%: 59.447, max_rt: 115.006, 2369|82.549, 237|9.279, 237|210.203, 236|151.900
 870, trx: 2305, 95%: 53.406, 99%: 65.580, max_rt: 97.323, 2309|47.439, 231|11.040, 232|142.359, 231|178.243
 880, trx: 2351, 95%: 51.568, 99%: 61.253, max_rt: 85.595, 2347|54.368, 235|10.795, 235|137.919, 235|167.001
 890, trx: 2319, 95%: 53.823, 99%: 62.307, max_rt: 75.282, 2321|44.424, 232|10.773, 231|138.292, 233|154.393
 900, trx: 2376, 95%: 51.229, 99%: 59.518, max_rt: 89.591, 2368|52.757, 237|8.498, 238|138.681, 236|154.939

STOPPING THREADS................

<Raw Results>
  [0] sc:9 lt:210498  rt:0  fl:0 avg_rt: 36.3 (5)
  [1] sc:0 lt:210273  rt:0  fl:0 avg_rt: 12.3 (5)
  [2] sc:19592 lt:1458  rt:0  fl:0 avg_rt: 3.3 (5)
  [3] sc:30 lt:21021  rt:0  fl:0 avg_rt: 106.5 (80)
  [4] sc:0 lt:21049  rt:0  fl:0 avg_rt: 111.4 (20)
 in 900 sec.

<Raw Results2(sum ver.)>
  [0] sc:9  lt:210499  rt:0  fl:0
  [1] sc:0  lt:210505  rt:0  fl:0
  [2] sc:19592  lt:1458  rt:0  fl:0
  [3] sc:30  lt:21021  rt:0  fl:0
  [4] sc:0  lt:21050  rt:0  fl:0

<Constraint Check> (all must be [OK])
 [transaction percentage]
        Payment: 43.45% (>=43.0%) [OK]
   Order-Status: 4.35% (>= 4.0%) [OK]
       Delivery: 4.35% (>= 4.0%) [OK]
    Stock-Level: 4.35% (>= 4.0%) [OK]
 [response time (at least 90% passed)]
      New-Order: 0.00%  [NG] *
        Payment: 0.00%  [NG] *
   Order-Status: 93.07%  [OK]
       Delivery: 0.14%  [NG] *
    Stock-Level: 0.00%  [NG] *

<TpmC>
                 14033.800 TpmC

```


{{<note>}}
解读：`10, trx: 2425, 95%: 51.645, 99%: 60.452, max_rt: 115.004, 2416|65.653, 241|12.825, 243|146.846, 242|167.750`

以逗号分隔，共6列：
- 第一列，上面默认的时间间隔：10秒
- 第二列，10秒内执行新订单交易次数：2425次，即这段时间内的吞吐量。在10s内新订单事务数，该值越大说明性能越好
- 第三列，95% 新订单交易平均响应时间：51.645毫秒
- 第四列，99% 新订单交易平均响应时间：60.452毫秒
- 第五列，新订单交易最大事务响应时间为：115.004毫秒
- 第五列，支付业务的结果，吞吐量|最大相应时间
- 第六列，发货业务的结果
- 第六列，库存业务的结果

{{</note>}}




















